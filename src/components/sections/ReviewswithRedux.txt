import React, { useEffect, useMemo, useState } from "react";
import {
  Box, Typography, Button, Card, CardContent, Avatar, Modal, TextField, Grid,
  Container, IconButton, Stack, Radio, RadioGroup, FormControlLabel, FormControl,
  FormLabel, Dialog, DialogTitle, DialogContent, DialogActions, Select, MenuItem,
  InputLabel, FormControl as MuiFormControl
} from "@mui/material";
import {
  Close as CloseIcon, Add as AddIcon, MoreVert as MoreVertIcon,
  Edit as EditIcon, Delete as DeleteIcon, FilterList as FilterListIcon,
} from "@mui/icons-material";
import { useDispatch, useSelector } from "react-redux";
import { selectUser, selectRole, selectUserId } from "../../features/auth/loginSlice";
import {
  fetchReviews, createReview, updateReview, deleteReview,
  selectReviews, selectReviewsStatus, selectReviewsError
} from "../../features/reviews/reviewsSlice";
import { cardData } from "/CardsData"; // keep your firms list
// --- Helpers kept from your file ---
const GRADE_OPTIONS = [
  { value: "A+", label: "A+ (Excellent)" },
  { value: "A",  label: "A (Very Good)" },
  { value: "B",  label: "B (Good)" },
  { value: "C",  label: "C (Average)" },
  { value: "D",  label: "D (Poor)" },
];
const TRADING_FIRMS = cardData.map((c) => ({ id: c.id, name: c.title }));
const formatDate = (s) =>
  new Date(s).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
const getGradeColor = (g) => ({ "A+": "#4caf50", A: "#8bc34a", B: "#c09d00ff", C: "#da8405ff", D: "#f44336" }[g] || "#9e9e9e");
const getGradeDisplay = (g) => ({ "A+": "A+ (Excellent)", A: "A (Very Good)", B: "B (Good)", C: "C (Average)", D: "D (Poor)" }[g] || g);

export default function Reviews() {
  const dispatch = useDispatch();
  const user = useSelector(selectUser);
  const role = useSelector(selectRole);     // "admin" | "user" | "guest"
  const userId = useSelector(selectUserId); // number | null
  const reviews = useSelector(selectReviews);
  const status = useSelector(selectReviewsStatus);
  const error = useSelector(selectReviewsError);

  const [openModal, setOpenModal] = useState(false);
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [selectedReview, setSelectedReview] = useState(null);
  const [isEditing, setIsEditing] = useState(false);
  const [activeActionCard, setActiveActionCard] = useState(null);
  const [showAllReviews, setShowAllReviews] = useState(false);
  const [ratingFilter, setRatingFilter] = useState("all");
  const [propNameFilter, setPropNameFilter] = useState("all");
  const [expandedReviewId, setExpandedReviewId] = useState(null);

  const [form, setForm] = useState({
    id: null,
    product_id: "",
    prop_name: "",
    reviewer_name: user?.name || "",
    reviewer_id: userId || null,
    rating: "",
    description: "",
  });

  useEffect(() => { dispatch(fetchReviews()); }, [dispatch]);

  // permissions
  const canModify = (review) => {
    if (role === "admin") return true;
    if (role === "user" && userId) return review.reviewer_id === userId;
    return false;
  };

  const handleActionMenuOpen = (id) => setActiveActionCard(id);
  const handleActionMenuClose = () => { setActiveActionCard(null); setSelectedReview(null); };

  const handleOpenModal = () => {
    setForm({
      id: null, product_id: "", prop_name: "", rating: "", description: "",
      reviewer_name: user?.name || "", reviewer_id: userId || null,
    });
    setIsEditing(false);
    setOpenModal(true);
  };
  const handleCloseModal = () => { setOpenModal(false); setIsEditing(false); };

  const handleEdit = (review) => {
    if (!canModify(review)) return;
    setSelectedReview(review);
    setForm({
      id: review.id,
      product_id: review.product_id,
      prop_name: review.prop_name,
      rating: review.rating,
      description: review.description,
      reviewer_name: review.reviewer_name,
      reviewer_id: review.reviewer_id,
    });
    setIsEditing(true);
    setOpenModal(true);
    setActiveActionCard(null);
  };

  const handleDeleteClick = (review) => {
    if (!canModify(review)) return;
    setSelectedReview(review);
    setDeleteDialogOpen(true);
    setActiveActionCard(null);
  };

  const handleDeleteConfirm = async () => {
    if (selectedReview) {
      await dispatch(deleteReview(selectedReview.id));
      setDeleteDialogOpen(false);
      setSelectedReview(null);
    }
  };
  const handleDeleteCancel = () => { setDeleteDialogOpen(false); setSelectedReview(null); };

  const handleToggleExpand = (id) => {
    setExpandedReviewId(expandedReviewId === id ? null : id);
  };

  const handleInputChange = (field, value) => {
    setForm((p) => ({ ...p, [field]: value }));
    if (field === "prop_name" && value) {
      const firm = TRADING_FIRMS.find((f) => f.name === value);
      if (firm) setForm((p) => ({ ...p, product_id: firm.id }));
    }
  };

  const handleSubmit = async () => {
    if (!form.reviewer_name || !form.description || !form.rating || !form.prop_name) return;

    if (isEditing && form.id) {
      await dispatch(updateReview({
        id: form.id,
        data: {
          product_id: form.product_id,
          prop_name: form.prop_name,
          rating: form.rating,
          description: form.description,
        },
      }));
    } else {
      await dispatch(createReview({
        product_id: form.product_id,
        prop_name: form.prop_name,
        rating: form.rating,
        description: form.description,
        reviewer_name: form.reviewer_name,
        reviewer_id: form.reviewer_id,
      }));
    }
    handleCloseModal();
  };

  // filters
  const filtered = useMemo(() => {
    return (reviews || []).filter((r) => {
      const matchRating = ratingFilter === "all" || r.rating === ratingFilter;
      const matchFirm = propNameFilter === "all" || r.prop_name === propNameFilter;
      return matchRating && matchFirm;
    });
  }, [reviews, ratingFilter, propNameFilter]);

  const displayed = showAllReviews ? filtered : filtered.slice(0, 9);
  const hasMore = filtered.length > 9;

  // UI Card
  const ReviewCard = ({ review }) => {
    const isActive = activeActionCard === review.id;
    const isExpanded = expandedReviewId === review.id;
    const needsReadMore = (review.description || "").length > 90;

    return (
      <>
        <Card
          sx={{
            width: { xs: "100%", md: 368 },
            height: "100%",
            minHeight: 150,
            display: "flex",
            flexDirection: "column",
            boxShadow: 2,
            transition: "all 0.3s ease-in-out",
            position: "relative",
            overflow: "hidden",
            background: "linear-gradient(to bottom, #ffffff 10%, #e6ccfaff 60%, #cd8cfcff 90%)",
            "&:hover": { transform: "translateY(-2px)", boxShadow: 4, cursor: "pointer" },
          }}
        >
          <CardContent sx={{ flexGrow: 1, pb: 1, position: "relative" }}>
            <Typography variant="caption" color="text.secondary" sx={{ position: "absolute", top: 8, right: 16, fontSize: "0.8rem" }}>
              {review.updated_at ? formatDate(review.updated_at) : ""}
            </Typography>

            <Box display="flex" justifyContent="space-between" alignItems="flex-start" mb={2} mt={2}>
              <Box display="flex" flexGrow={1}>
                <Avatar sx={{ bgcolor: "#4b0082", mr: 2, mt: 0.5, width: 40, height: 40 }}>
                  {(review.reviewer_name || "?").charAt(0).toUpperCase()}
                </Avatar>
                <Box flexGrow={1}>
                  <Typography variant="h6" component="div" fontWeight="medium">
                    {review.reviewer_name}
                  </Typography>
                  <Typography variant="body1" color="text.secondary" sx={{ mb: 0.5 }}>
                    Firm: <strong>{review.prop_name}</strong>
                  </Typography>
                  <Typography variant="body1" fontWeight="bold" sx={{ color: getGradeColor(review.rating) }}>
                    {getGradeDisplay(review.rating)}
                  </Typography>
                </Box>
              </Box>

              {canModify(review) && (
                <IconButton
                  size="small"
                  onClick={() => handleActionMenuOpen(review.id)}
                  sx={{ ml: 1, alignSelf: "flex-start", visibility: isActive ? "hidden" : "visible",
                        "&:hover": { backgroundColor: "rgba(0,0,0,0.2)" }, zIndex: 5 }}
                >
                  <MoreVertIcon />
                </IconButton>
              )}
            </Box>

            <Typography
              variant="body1"
              color="text.secondary"
              sx={{
                display: "-webkit-box",
                WebkitLineClamp: isExpanded ? "unset" : 2,
                WebkitBoxOrient: "vertical",
                overflow: "hidden",
                lineHeight: 1.5,
                maxHeight: isExpanded ? "none" : "4.5em",
              }}
            >
              {review.description}
            </Typography>

            {needsReadMore && !isExpanded && (
              <Button size="small" onClick={() => handleToggleExpand(review.id)}
                sx={{ mt: 1, textTransform: "capitalize", color: "#4b0082", fontWeight: "bold", p: 0, minWidth: "auto",
                      "&:hover": { backgroundColor: "transparent", color: "#8f7900ff" } }}>
                Read More
              </Button>
            )}
          </CardContent>

          {isActive && (
            <Box sx={{
              position: "absolute", inset: 0, display: "flex", flexDirection: "column",
              justifyContent: "center", alignItems: "center", backgroundColor: "rgba(255,255,255,0.2)",
              backdropFilter: "blur(4px)", zIndex: 10, gap: 2, p: 2
            }}>
              <IconButton
                size="small"
                onClick={handleActionMenuClose}
                sx={{ position: "absolute", top: 8, right: 8, backgroundColor: "rgba(0,0,0,0.1)",
                      "&:hover": { backgroundColor: "rgba(0,0,0,0.2)" } }}
              >
                <CloseIcon />
              </IconButton>

              <Button variant="contained" startIcon={<EditIcon />} onClick={() => handleEdit(review)}
                sx={{ minWidth: 110, borderRadius: 2, textTransform: "capitalize", fontFamily: "Lora, Helvetica",
                      border: "1px solid #fff", "&:hover": { border: "1px solid #ffd700" } }}>
                Edit
              </Button>

              <Button variant="contained" color="error" startIcon={<DeleteIcon />} onClick={() => handleDeleteClick(review)}
                sx={{ minWidth: 110, borderRadius: 2, textTransform: "capitalize", fontFamily: "Lora, Helvetica",
                      border: "1px solid #fff", "&:hover": { border: "1px solid #ffd700" } }}>
                Delete
              </Button>
            </Box>
          )}
        </Card>

        {/* Expanded modal */}
        <Dialog open={isExpanded} onClose={() => handleToggleExpand(review.id)} maxWidth="md" fullWidth>
          <DialogTitle>
            <Box display="flex" justifyContent="space-between" alignItems="center">
              <Typography variant="h6">Review Details</Typography>
              <IconButton onClick={() => handleToggleExpand(review.id)} size="small">
                <CloseIcon />
              </IconButton>
            </Box>
          </DialogTitle>
          <DialogContent>
            <Box display="flex" alignItems="center" mb={3}>
              <Avatar sx={{ bgcolor: "#4b0082", mr: 2, width: 48, height: 48 }}>
                {(review.reviewer_name || "?").charAt(0).toUpperCase()}
              </Avatar>
              <Box>
                <Typography variant="h6" fontWeight="medium">{review.reviewer_name}</Typography>
                <Typography variant="body1" color="text.secondary" sx={{ mb: 0.5 }}>
                  Firm: <strong>{review.prop_name}</strong>
                </Typography>
                <Typography variant="body1" fontWeight="bold" sx={{ color: getGradeColor(review.rating) }}>
                  {getGradeDisplay(review.rating)}
                </Typography>
                {!!review.updated_at && (
                  <Typography variant="body2" color="text.secondary">Updated: {formatDate(review.updated_at)}</Typography>
                )}
              </Box>
            </Box>
            <Typography variant="body1" color="text.secondary" sx={{ fontSize: "1.2rem", lineHeight: 1.6, whiteSpace: "pre-wrap" }}>
              {review.description}
            </Typography>
          </DialogContent>
        </Dialog>
      </>
    );
  };

  return (
    <Container maxWidth="lg">
      {/* Header */}
      <Box sx={{
        mb: 4, display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap",
        gap: 2, flexDirection: { xs: "column", md: "row" }, bgcolor: "rgba(255,255,255,0.12)",
        borderRadius: "10px", overflow: "hidden", p: { xs: 2, md: 4 }, my: { md: 6 },
        boxShadow: "0 4px 12px rgba(0,0,0,0.1)", border: "1px solid #cecece",
      }}>
        <Box display="flex" flexDirection="column">
          <Typography variant="h4" sx={{ fontFamily: "Montserrat, Helvetica", fontWeight: "bold", color: "white", lineHeight: "2.25rem", mb: 2 }}>
            Our Reviews
          </Typography>
          <Typography variant="body2" sx={{ fontFamily: "Lora, Helvetica", color: "#cecece" }}>
            Read what our critics have to say about trading firms.
          </Typography>
        </Box>

        {/* Only logged-in users can add reviews; keep your original 'adminLoggedIn' intent */}
        {role !== "guest" && (
          <Button variant="contained" startIcon={<AddIcon />} onClick={handleOpenModal}
            sx={{ borderRadius: 2, textTransform: "capitalize", bgcolor: "#4b0082", px: 2, py: 1.5,
                  fontFamily: "Lora, Helvetica", border: "1px solid #fff",
                  "&:hover": { bgcolor: "#4b0082b2", border: "1px solid #ffd700" } }}>
            Write a Review
          </Button>
        )}
      </Box>

      {/* Filters */}
      <Box sx={{ mb: 3, display: "flex", gap: 2, flexWrap: "wrap" }}>
        <MuiFormControl size="small" sx={{
          minWidth: 200, "& .MuiInputLabel-root, & .MuiSelect-select, & .MuiSvgIcon-root": { color: "white" },
          "& .MuiOutlinedInput-notchedOutline": { borderColor: "white" }, "&:hover .MuiOutlinedInput-notchedOutline": { borderColor: "#bbb" },
        }}>
          <InputLabel id="rating-filter-label">
            <Box display="flex" alignItems="center">
              <FilterListIcon sx={{ fontSize: 18, mr: 0.5, color: "white" }} />
              Filter by Rating
            </Box>
          </InputLabel>
          <Select labelId="rating-filter-label" value={ratingFilter} label="Filter by Rating"
                  onChange={(e) => { setRatingFilter(e.target.value); setShowAllReviews(false); }}>
            <MenuItem value="all">All Ratings</MenuItem>
            {GRADE_OPTIONS.map((o) => <MenuItem key={o.value} value={o.value}>{o.label}</MenuItem>)}
          </Select>
        </MuiFormControl>

        <MuiFormControl size="small" sx={{
          minWidth: 200, "& .MuiInputLabel-root, & .MuiSelect-select, & .MuiSvgIcon-root": { color: "white" },
          "& .MuiOutlinedInput-notchedOutline": { borderColor: "white" }, "&:hover .MuiOutlinedInput-notchedOutline": { borderColor: "#bbb" },
        }}>
          <InputLabel id="firm-filter-label">
            <Box display="flex" alignItems="center">
              <FilterListIcon sx={{ fontSize: 18, mr: 0.5, color: "white" }} />
              Filter by Firm
            </Box>
          </InputLabel>
          <Select labelId="firm-filter-label" value={propNameFilter} label="Filter by Firm"
                  onChange={(e) => { setPropNameFilter(e.target.value); setShowAllReviews(false); }}>
            <MenuItem value="all">All Trading Firms</MenuItem>
            {TRADING_FIRMS.map((f) => <MenuItem key={f.id} value={f.name}>{f.name}</MenuItem>)}
          </Select>
        </MuiFormControl>

        <Box sx={{ flexGrow: 1, display: "flex", alignItems: "center", justifyContent: "flex-end" }}>
          <Typography variant="body2" sx={{ color: "#cecece" }}>
            {status === "loading" ? "Loading…" :
              `Showing ${displayed.length} of ${filtered.length} reviews`}
            {ratingFilter !== "all" && ` (filtered by ${getGradeDisplay(ratingFilter)})`}
            {propNameFilter !== "all" && ` (${propNameFilter})`}
          </Typography>
        </Box>
      </Box>

      {/* Grid */}
      <Grid container spacing={3} wrap="wrap">
        {displayed.map((review) => (
          <Grid key={review.id} size={{ xs: 12, sm: 6, lg: 4 }}>
            <ReviewCard review={review} />
          </Grid>
        ))}
      </Grid>

      {/* View all */}
      {hasMore && !showAllReviews && (
        <Box textAlign="center" mt={4}>
          <Button variant="contained" onClick={() => setShowAllReviews(true)} size="large"
            sx={{ borderRadius: 2, textTransform: "capitalize", bgcolor: "#000", px: 2, py: 1.5, fontFamily: "Lora, Helvetica",
                  border: "1px solid #fff", "&:hover": { bgcolor: "#4b0082b2", border: "1px solid #ffd700" } }}>
            View All Reviews ({filtered.length})
          </Button>
        </Box>
      )}

      {/* Empty state */}
      {status === "succeeded" && filtered.length === 0 && (
        <Box textAlign="center" py={6} sx={{ bgcolor: "#ffffff50", borderRadius: 2, mt: 4 }}>
          <Typography variant="h6" color="text.secondary" gutterBottom>No reviews found</Typography>
          <Typography variant="body1" color="text.secondary" mb={3}>
            {ratingFilter === "all" && propNameFilter === "all"
              ? "Be the first to share your experience!"
              : "No reviews found with the current filters"}
          </Typography>
          {role !== "guest" && (
            <Button variant="contained" startIcon={<AddIcon />} onClick={handleOpenModal}
              sx={{ borderRadius: 2, textTransform: "capitalize", bgcolor: "#000", px: 2, py: 1.5, fontFamily: "Lora, Helvetica",
                    border: "1px solid #fff", "&:hover": { bgcolor: "#4b0082b2", border: "1px solid #ffd700" } }}>
              Write the First Review
            </Button>
          )}
        </Box>
      )}

      {/* Delete dialog */}
      <Dialog open={deleteDialogOpen} onClose={handleDeleteCancel} maxWidth="sm" fullWidth>
        <DialogTitle>Delete Review</DialogTitle>
        <DialogContent>
          <Typography>
            Are you sure you want to delete {selectedReview?.reviewer_name}'s review for {selectedReview?.prop_name}? This action cannot be undone.
          </Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleDeleteCancel} sx={{ textTransform: "capitalize" }}>Cancel</Button>
          <Button onClick={handleDeleteConfirm} color="error" variant="contained"
            sx={{ borderRadius: 2, textTransform: "capitalize", fontFamily: "Lora, Helvetica", border: "1px solid #fff",
                  "&:hover": { border: "1px solid #ffd700" } }}>
            Delete
          </Button>
        </DialogActions>
      </Dialog>

      {/* Create / Edit modal */}
      <Modal open={openModal} onClose={handleCloseModal} aria-labelledby="write-review-modal">
        <Box sx={{
          position: "absolute", top: "50%", left: "50%", transform: "translate(-50%, -50%)",
          width: 500, maxWidth: "90vw", bgcolor: "background.paper", boxShadow: 24, p: 4,
          borderRadius: 2, outline: "none", maxHeight: "90vh", overflowY: "auto",
        }}>
          <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
            <Typography variant="h6">{isEditing ? "Edit Review" : "Write a Review"}</Typography>
            <IconButton onClick={handleCloseModal} size="small"><CloseIcon /></IconButton>
          </Box>

          <Stack spacing={3}>
            <TextField
              fullWidth label="Your Name" value={form.reviewer_name || ""} disabled
              helperText={role === "guest" ? "Login to write a review" : ""}
            />

            <FormControl fullWidth required>
              <InputLabel id="prop-name-label">Trading Firm</InputLabel>
              <Select
                labelId="prop-name-label"
                value={form.prop_name}
                label="Trading Firm"
                onChange={(e) => handleInputChange("prop_name", e.target.value)}
              >
                {TRADING_FIRMS.map((f) => <MenuItem key={f.id} value={f.name}>{f.name}</MenuItem>)}
              </Select>
            </FormControl>

            <FormControl component="fieldset" required>
              <FormLabel component="legend">Your Rating</FormLabel>
              <RadioGroup
                value={form.rating}
                onChange={(e) => handleInputChange("rating", e.target.value)}
                sx={{ mt: 1 }}
              >
                {GRADE_OPTIONS.map((o) => (
                  <FormControlLabel key={o.value} value={o.value} control={<Radio />} label={o.label}
                    sx={{ "& .MuiFormControlLabel-label": { fontSize: "0.9rem" } }} />
                ))}
              </RadioGroup>
            </FormControl>

            <TextField
              fullWidth label="Your Review" value={form.description}
              onChange={(e) => handleInputChange("description", e.target.value)}
              variant="outlined" multiline rows={4} placeholder="Share your experience…" required
            />

            <Box display="flex" gap={2} justifyContent="flex-end">
              <Button variant="outlined" onClick={handleCloseModal}>Cancel</Button>
              <Button variant="contained" onClick={handleSubmit}
                disabled={
                  role === "guest" ||
                  !form.reviewer_name || !form.description || !form.rating || !form.prop_name
                }>
                {isEditing ? "Update Review" : "Submit Review"}
              </Button>
            </Box>
          </Stack>
        </Box>
      </Modal>
    </Container>
  );
}
